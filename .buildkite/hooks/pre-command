#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

main() {
  echo '--- :sparkles: Preparing build environment...'
  mkdir -p environ
  curl -sSL https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-121.0.0-linux-x86_64.tar.gz | tar xfz - -C environ

  environ/google-cloud-sdk/bin/gcloud --quiet components update
  echo "$GCP_SERVICE_KEY" | base64 --decode -i > "environ/gcloud-service-key.json"
  environ/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file "environ/gcloud-service-key.json"
  environ/google-cloud-sdk/bin/gcloud config set project "$GCP_PROJECT_NAME"
}

main
